{{define "content"}}
<div id="usersApp" class="bg-white p-5 rounded-2xl shadow-sm">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-5">
        <h3 class="text-lg font-semibold">사용자 관리</h3>
        <div class="flex gap-2 w-full md:w-auto">
            <select v-model="userTypeFilter" @change="loadUsers(1)" class="flex-1 md:flex-none px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500">
                <option value="">전체</option>
                <option value="U">일반 사용자</option>
                <option value="A">관리자</option>
            </select>
            <button @click="loadUsers(currentPage)" class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm font-medium hover:bg-indigo-600 transition">
                🔄 새로고침
            </button>
        </div>
    </div>

    <!-- 데스크톱 테이블 -->
    <div class="hidden md:block overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 bg-gray-50 font-semibold text-gray-800 text-sm">아이디</th>
                    <th class="text-left py-3 px-4 bg-gray-50 font-semibold text-gray-800 text-sm">이름</th>
                    <th class="text-left py-3 px-4 bg-gray-50 font-semibold text-gray-800 text-sm">이메일</th>
                    <th class="text-left py-3 px-4 bg-gray-50 font-semibold text-gray-800 text-sm">권한 타입</th>
                    <th class="text-left py-3 px-4 bg-gray-50 font-semibold text-gray-800 text-sm">권한 레벨</th>
                    <th class="text-left py-3 px-4 bg-gray-50 font-semibold text-gray-800 text-sm">등록일</th>
                    <th class="text-left py-3 px-4 bg-gray-50 font-semibold text-gray-800 text-sm">작업</th>
                </tr>
            </thead>
            <tbody>
                <tr v-if="loading">
                    <td colspan="7" class="text-center py-10">
                        <div class="inline-block w-10 h-10 border-4 border-gray-200 border-t-indigo-500 rounded-full animate-spin"></div>
                    </td>
                </tr>
                <tr v-else-if="users.length === 0">
                    <td colspan="7" class="text-center py-5 text-gray-500">사용자가 없습니다</td>
                </tr>
                <tr v-else v-for="user in users" :key="user.id" class="border-b border-gray-100 hover:bg-gray-50 transition">
                    <td class="py-3 px-4">{{ user.id }}</td>
                    <td class="py-3 px-4">{{ user.name }}</td>
                    <td class="py-3 px-4">{{ user.email }}</td>
                    <td class="py-3 px-4">
                        <span v-if="user.auth_type === 'A'" class="px-3 py-1 rounded-xl text-xs font-semibold bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
                            관리자
                        </span>
                        <span v-else class="px-3 py-1 rounded-xl text-xs font-semibold bg-gray-200 text-gray-600">
                            일반
                        </span>
                    </td>
                    <td class="py-3 px-4">{{ user.auth_level }}</td>
                    <td class="py-3 px-4">{{ formatDate(user.created_at) }}</td>
                    <td class="py-3 px-4">
                        <button @click="openEditModal(user)" class="px-3 py-1 bg-indigo-500 text-white rounded-lg text-xs font-medium hover:bg-indigo-600 transition mr-1">
                            수정
                        </button>
                        <button @click="deleteUser(user.id)" class="px-3 py-1 bg-red-500 text-white rounded-lg text-xs font-medium hover:bg-red-600 transition">
                            삭제
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 모바일 카드 -->
    <div class="md:hidden">
        <div v-if="loading" class="text-center py-10">
            <div class="inline-block w-10 h-10 border-4 border-gray-200 border-t-indigo-500 rounded-full animate-spin"></div>
        </div>
        <div v-else-if="users.length === 0" class="text-center py-5 text-gray-500">
            사용자가 없습니다
        </div>
        <div v-else v-for="user in users" :key="'card-' + user.id" class="bg-gray-50 p-4 rounded-xl mb-3 border border-gray-200">
            <div class="flex justify-between items-center mb-3">
                <div class="font-semibold text-base text-gray-800">{{ user.name }}</div>
                <span v-if="user.auth_type === 'A'" class="px-3 py-1 rounded-xl text-xs font-semibold bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
                    관리자
                </span>
                <span v-else class="px-3 py-1 rounded-xl text-xs font-semibold bg-gray-200 text-gray-600">
                    일반
                </span>
            </div>
            <div class="text-sm text-gray-600 my-1">📧 {{ user.email }}</div>
            <div class="text-sm text-gray-600 my-1">🆔 {{ user.id }}</div>
            <div class="text-sm text-gray-600 my-1">🔑 레벨 {{ user.auth_level }}</div>
            <div class="text-sm text-gray-600 my-1">📅 {{ formatDate(user.created_at) }}</div>
            <div class="flex gap-2 mt-3">
                <button @click="openEditModal(user)" class="flex-1 px-3 py-2 bg-indigo-500 text-white rounded-lg text-sm font-medium hover:bg-indigo-600 transition">
                    수정
                </button>
                <button @click="deleteUser(user.id)" class="flex-1 px-3 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition">
                    삭제
                </button>
            </div>
        </div>
    </div>

    <!-- 페이지네이션 -->
    <div v-if="totalPages > 1" class="flex justify-center gap-2 mt-5">
        <button
            v-for="page in totalPages"
            :key="page"
            @click="loadUsers(page)"
            :class="['px-3 py-1 rounded-lg text-sm font-medium transition',
                     page === currentPage ?
                     'bg-indigo-500 text-white' :
                     'bg-gray-200 text-gray-700 hover:bg-gray-300']"
        >
            {{ page }}
        </button>
    </div>
</div>

<!-- 권한 수정 모달 -->
<div v-if="showModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" @click.self="closeModal">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md animate-slideUp">
        <h3 class="text-xl font-semibold mb-5">권한 수정</h3>
        <div class="mb-4">
            <label class="block mb-2 text-sm font-medium text-gray-700">권한 타입</label>
            <select v-model="editForm.auth_type" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-indigo-500">
                <option value="U">일반 사용자</option>
                <option value="A">관리자</option>
            </select>
        </div>
        <div class="mb-5">
            <label class="block mb-2 text-sm font-medium text-gray-700">권한 레벨 (1-10)</label>
            <input
                type="number"
                v-model.number="editForm.auth_level"
                min="1"
                max="10"
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-indigo-500"
            >
        </div>
        <div class="flex gap-3">
            <button @click="saveAuth" class="flex-1 px-4 py-3 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-xl font-semibold hover:opacity-90 transition">
                저장
            </button>
            <button @click="closeModal" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-300 transition">
                취소
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .animate-slideUp {
        animation: slideUp 0.3s ease;
    }
</style>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                users: [],
                loading: true,
                currentPage: 1,
                totalPages: 1,
                userTypeFilter: '',
                showModal: false,
                editForm: {
                    user_id: '',
                    auth_type: 'U',
                    auth_level: 1
                }
            }
        },
        mounted() {
            this.loadUsers();
        },
        methods: {
            async loadUsers(page = 1) {
                this.currentPage = page;
                this.loading = true;

                const url = `/api/admin/users?page=${page}&limit=20${this.userTypeFilter ? '&user_type=' + this.userTypeFilter : ''}`;

                try {
                    const data = await apiCall(url);

                    if (data.success && data.data.users) {
                        this.users = data.data.users;
                        this.totalPages = Math.ceil(data.data.total / data.data.limit);
                    } else {
                        this.users = [];
                        this.totalPages = 1;
                    }
                } catch (error) {
                    console.error('사용자 로드 실패:', error);
                    this.users = [];
                } finally {
                    this.loading = false;
                }
            },
            openEditModal(user) {
                this.editForm = {
                    user_id: user.id,
                    auth_type: user.auth_type,
                    auth_level: user.auth_level
                };
                this.showModal = true;
            },
            closeModal() {
                this.showModal = false;
            },
            async saveAuth() {
                if (this.editForm.auth_level < 1 || this.editForm.auth_level > 10) {
                    alert('권한 레벨은 1-10 사이여야 합니다');
                    return;
                }

                try {
                    const data = await apiCall(`/api/admin/users/${this.editForm.user_id}/auth`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            auth_type: this.editForm.auth_type,
                            auth_level: this.editForm.auth_level
                        })
                    });

                    if (data.success) {
                        alert('권한이 수정되었습니다');
                        this.closeModal();
                        this.loadUsers(this.currentPage);
                    } else {
                        alert(data.error?.message || '수정에 실패했습니다');
                    }
                } catch (error) {
                    alert('서버 오류가 발생했습니다');
                }
            },
            async deleteUser(userId) {
                if (!confirm(`사용자 "${userId}"를 삭제하시겠습니까?`)) {
                    return;
                }

                try {
                    const data = await apiCall(`/api/admin/users/${userId}`, {
                        method: 'DELETE'
                    });

                    if (data.success) {
                        alert('사용자가 삭제되었습니다');
                        this.loadUsers(this.currentPage);
                    } else {
                        alert(data.error?.message || '삭제에 실패했습니다');
                    }
                } catch (error) {
                    alert('서버 오류가 발생했습니다');
                }
            },
            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('ko-KR');
            }
        }
    }).mount('#usersApp');
</script>
{{end}}